# AbyssCurse 插件开发备忘录

## 阶段 I：插件基础框架（已完成）

### 完成时间
2024年（第一阶段）

### 完成内容

#### 1. 配置管理系统 (ConfigManager)
- ✅ 实现了配置文件的加载和保存
- ✅ 支持默认配置值设置
- ✅ 提供配置重载功能
- ✅ 管理插件模式、Abyss区域配置、诅咒模式、调试开关等配置项
- ✅ 配置文件位置：`plugins/AbyssCurse/config.yml`

#### 2. 模式管理系统 (ModeManager)
- ✅ 实现了三种插件模式的管理：
  - `OFF`: 关闭模式，插件不对任何玩家施加诅咒
  - `ABYSS`: 区域开启模式，仅在定义的 abyss 区域内施加诅咒
  - `WORLD`: 全部开启模式，整个主世界都被视为 abyss
- ✅ 模式切换验证（ABYSS 模式需要有效的区域配置）
- ✅ 模式状态查询接口

#### 3. 命令处理系统 (CommandHandler)
- ✅ 实现了基础命令处理框架
- ✅ 支持的命令：
  - `/abysscurse mode <off|abyss|world> [x] [y] [z] [radius]` - 切换插件模式
  - `/abysscurse reload` - 重载配置文件
  - `/abysscurse info` - 查看插件信息
  - `/abysscurse debug <on|off|toggle|info|global> [on|off]` - 调试模式控制
  - `/abysscurse` - 显示帮助信息
- ✅ 实现了命令补全（TabCompleter）
- ✅ 权限检查（`abysscurse.admin`）
- ✅ 友好的错误提示和帮助信息

#### 4. 调试管理系统 (DebugManager)
- ✅ 实现了调试信息显示功能（ActionBar 实时显示）
- ✅ 支持全局调试开关（通过配置文件或命令）
- ✅ 支持玩家级别调试开关（每个玩家独立控制）
- ✅ 实现了调试命令处理
- ✅ 每秒更新一次调试信息（每 20 tick）
- ✅ 显示当前可获取的信息：
  - 当前模式（OFF/ABYSS/WORLD）
  - 玩家位置坐标
  - Abyss 区域信息（中心坐标和半径，仅在 ABYSS 模式下显示）
- ✅ 为后续功能预留接口（当前层级、累计上升高度、安全高度等）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/debug/DebugManager.java`

**调试命令**：
- `/abysscurse debug on` - 开启玩家调试模式
- `/abysscurse debug off` - 关闭玩家调试模式
- `/abysscurse debug toggle` - 切换玩家调试模式
- `/abysscurse debug info` - 查看详细调试信息（聊天栏）
- `/abysscurse debug global <on|off>` - 控制全局调试模式

**技术实现**：
- 使用 Paper 1.21 的 Adventure API（Component、NamedTextColor）
- 使用 BukkitScheduler 实现定时更新
- 使用 HashSet<UUID> 存储调试玩家列表，保证线程安全

**预留接口**（待后续阶段完善）：
- 当前层级 - 需要 PlayerDataManager
- 累计上升高度 - 需要 PlayerDataManager
- 安全高度 - 需要 PlayerDataManager
- 是否在 abyss 内 - 需要 RegionManager
- 是否在豁免区内 - 需要 RegionManager
- 是否为生骸 - 需要 PlayerDataManager

#### 5. 主类集成
- ✅ 更新了 `AbyssCursePlugin` 主类
- ✅ 集成了所有管理器模块
- ✅ 实现了优雅的启动和关闭流程
- ✅ 异常处理和日志记录

#### 6. 配置文件
- ✅ 创建了 `plugin.yml`，包含命令和权限定义
- ✅ 创建了默认 `config.yml` 配置文件
- ✅ 命令别名：`ac`, `abyss`

### 技术实现

#### 文件结构
```
src/main/java/io/github/kaleidscoper/abysscurse/
├── AbyssCursePlugin.java (主类)
├── AbyssCurseListener.java (事件监听器)
├── config/
│   └── ConfigManager.java (配置管理器)
├── mode/
│   ├── PluginMode.java (模式枚举)
│   └── ModeManager.java (模式管理器)
├── command/
│   └── CommandHandler.java (命令处理器)
└── debug/
    └── DebugManager.java (调试管理器)
```

#### 核心特性
1. **模块化设计**：各功能模块独立，通过接口交互
2. **配置驱动**：支持配置文件和命令动态配置
3. **性能优化**：使用单例模式管理资源，避免重复创建
4. **错误处理**：完善的异常处理和用户友好的错误提示
5. **可扩展性**：为后续功能扩展预留接口

### 验证结果

#### 功能验证
- ✅ 插件能正常加载和卸载
- ✅ 配置文件能正确创建和加载
- ✅ 模式切换命令正常工作
- ✅ 命令补全功能正常
- ✅ 权限检查正常工作
- ✅ 构建成功，无编译错误

#### 性能验证
- ✅ 启动时间：快速（< 1秒）
- ✅ 内存占用：低（基础框架）
- ✅ 命令响应：即时

### 占位性功能说明

⚠️ **重要**：以下功能在当前阶段仅为占位实现，仅提供基础框架和接口，**没有实际功能**。这些功能需要在后续阶段完善。

#### 1. 事件监听器 (AbyssCurseListener)
- **当前状态**：仅实现了 `PlayerJoinEvent` 监听，显示欢迎消息
- **占位内容**：
  - 仅发送欢迎消息，无其他功能
  - 未实现玩家数据加载
  - 未实现安全高度初始化
  - 未实现其他事件监听（PlayerMoveEvent、PlayerQuitEvent 等）
- **待实现**：
  - 玩家加入时加载数据并初始化安全高度
  - 玩家移动事件监听（检测 Y 坐标变化）
  - 玩家退出时保存数据
  - 其他相关事件监听

#### 2. 模式切换功能
- **当前状态**：可以切换模式并保存到配置文件
- **占位内容**：
  - ✅ 模式状态可以切换和保存
  - ❌ **没有实际功能**：切换模式后不会对游戏产生任何影响
  - ❌ 不会检查玩家是否在 Abyss 区域内
  - ❌ 不会根据模式施加或移除诅咒效果
- **待实现**：
  - 模式切换时通知相关模块（RegionManager、CurseManager）
  - 根据模式状态实际控制诅咒系统
  - 模式切换时的效果清理和重新应用

#### 3. Abyss 区域配置
- **当前状态**：可以设置和保存 Abyss 区域配置（中心坐标和半径）
- **占位内容**：
  - ✅ 配置可以保存到文件
  - ❌ **没有 RegionManager**：无法判断玩家是否在 Abyss 区域内
  - ❌ 无法计算诅咒臂（Arm of Curse）
  - ❌ 无法判断玩家是否在豁免区内
- **待实现**：
  - 实现 RegionManager 模块
  - 实现区域判断逻辑（切比雪夫距离计算）
  - 实现豁免区管理
  - 实现区域查询 API

#### 4. 诅咒系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 CurseManager
  - ❌ 没有累计上升高度计算
  - ❌ 没有诅咒触发逻辑
  - ❌ 没有诅咒效果施加
- **待实现**：
  - 实现 CurseManager 和 AbyssCurseHandler
  - 实现累计上升高度计算（时间窗口队列）
  - 实现诅咒触发条件判断
  - 实现诅咒层级判断（根据安全高度）
  - 实现动态诅咒持续时间计算

#### 5. 效果系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 EffectManager
  - ❌ 没有效果施加逻辑
  - ❌ 没有效果合并机制
  - ❌ 没有层级效果
- **待实现**：
  - 实现 EffectManager
  - 实现诅咒效果施加器（CurseEffectApplier）
  - 实现层级效果施加器（LayerEffectApplier）
  - 实现效果合并逻辑（避免覆盖）
  - 实现效果定期刷新机制

#### 6. 玩家数据管理
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 PlayerDataManager
  - ❌ 没有玩家数据持久化
  - ❌ 没有玩家数据加载
  - ❌ 没有安全高度、累计上升高度等数据存储
- **待实现**：
  - 实现 PlayerDataManager
  - 实现 PlayerCurseData 数据结构
  - 实现数据持久化（异步保存）
  - 实现数据加载和初始化

#### 7. 其他占位功能
- **滤镜系统**：未实现（FilterManager）
- **音效系统**：未实现（SoundManager）
- **生骸系统**：未实现（NarehateManager）
- **成就系统**：未实现（AchievementManager）

### 功能完整性说明

| 模块 | 框架 | 配置 | 实际功能 | 状态 |
|------|------|------|----------|------|
| ConfigManager | ✅ | ✅ | ✅ | 完整 |
| ModeManager | ✅ | ✅ | ⚠️ 占位 | 框架完成 |
| CommandHandler | ✅ | ✅ | ⚠️ 占位 | 框架完成 |
| DebugManager | ✅ | ✅ | ✅ | 完整 |
| AbyssCurseListener | ✅ | ❌ | ⚠️ 占位 | 仅欢迎消息 |
| RegionManager | ❌ | ❌ | ❌ | 未实现 |
| PlayerDataManager | ❌ | ❌ | ❌ | 未实现 |
| CurseManager | ❌ | ❌ | ❌ | 未实现 |
| EffectManager | ❌ | ❌ | ❌ | 未实现 |

**图例**：
- ✅ = 已实现
- ⚠️ = 占位实现（无实际功能）
- ❌ = 未实现

### 已知问题
- 无

### 下一步计划
根据开发方案，下一阶段将实现：
1. RegionManager - 区域管理系统
2. PlayerDataManager - 玩家数据管理系统
3. 事件监听系统完善（PlayerMoveEvent 等）

### 接手开发指南

#### 快速开始
1. **阅读文档**：
   - `doc/需求文档.md` - 了解完整需求
   - `doc/开发方案.md` - 了解技术实现方案
   - `doc/ROADMAP.md` - 了解开发路线图

2. **理解当前状态**：
   - 当前仅完成基础框架（阶段 I）
   - 所有核心功能都是占位实现，无实际效果
   - 模式切换命令可以执行，但不会产生游戏内影响

3. **测试当前功能**：
   ```bash
   # 构建插件
   ./gradlew build
   
   # 在服务器上测试
   /abysscurse mode off      # 切换到关闭模式
   /abysscurse mode abyss 0 64 0 5  # 切换到区域模式并设置区域
   /abysscurse mode world    # 切换到世界模式
   /abysscurse info          # 查看插件信息
   /abysscurse reload        # 重载配置
   /abysscurse debug on      # 开启调试模式（显示 ActionBar 信息）
   /abysscurse debug info    # 查看详细调试信息
   /abysscurse debug global on  # 开启全局调试模式
   ```

4. **下一步开发建议**：
   - 优先实现 RegionManager（区域判断是核心功能的基础）
   - 然后实现 PlayerDataManager（数据管理是诅咒系统的基础）
   - 最后实现 CurseManager 和 EffectManager（核心玩法）

#### 代码结构说明
- **已完成模块**：可以直接使用，API 稳定
- **占位功能**：需要实现实际逻辑，但接口已预留
- **未实现模块**：需要从零开始实现

#### 注意事项
- ⚠️ **不要删除占位代码**：占位代码提供了接口和结构，是后续开发的基础
- ⚠️ **保持模块化**：新增功能应遵循现有的模块化设计
- ⚠️ **异步处理**：所有文件 I/O 和耗时操作必须使用异步任务
- ⚠️ **性能优化**：参考开发方案中的性能优化建议

### 备注
- 所有代码遵循 Java 编码规范
- 使用 PaperMC 1.21.10 API
- 配置文件使用 YAML 格式
- 日志使用 Bukkit Logger 系统
- 占位功能标记：在代码中使用 `// TODO: 占位实现` 或 `// FIXME: 需要实现实际功能` 注释

---

## 阶段 II：数据结构与区域系统（已完成）

### 完成时间
2024年（第二阶段）

### 完成内容

#### 1. 区域管理系统 (RegionManager)
- ✅ 实现了 Abyss 区域判断逻辑
  - 支持 OFF、ABYSS、WORLD 三种模式
  - ABYSS 模式：使用切比雪夫距离计算，判断玩家是否在区域内
  - WORLD 模式：整个主世界都被视为 Abyss
- ✅ 实现了诅咒臂（Arm of Curse）计算
  - 计算玩家所在区块与中心区块的切比雪夫距离
  - WORLD 模式下诅咒臂始终为 0
- ✅ 实现了豁免区管理
  - 支持添加/删除豁免区（使用两个角点坐标定义）
  - 判断玩家是否在豁免区内
  - 豁免区数据持久化到配置文件
- ✅ 实现了豁免者（生骸）管理
  - 支持添加/删除豁免者（玩家 UUID）
  - 豁免者数据持久化到配置文件
- ✅ 实现了综合判断方法 `isAffectedByCurse()`
  - 判断玩家是否受诅咒影响（必须在 Abyss 内、不在豁免区、不是豁免者）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/region/RegionManager.java`
- ✅ 相关类：`ExemptionZone.java`（豁免区数据类）

**技术实现**：
- 使用切比雪夫距离（Chebyshev distance）计算区域判断，性能优化
- 区块坐标计算：`chunkX = blockX >> 4, chunkZ = blockZ >> 4`
- 豁免区使用矩形区域判断（包含检查）
- 配置文件路径：`exemption.zones` 和 `exemption.players`

#### 2. 玩家数据管理系统 (PlayerDataManager)
- ✅ 实现了玩家数据管理
  - 使用 `ConcurrentHashMap` 存储在线玩家数据缓存（线程安全）
  - 提供数据访问接口 `getData(Player)`
- ✅ 实现了玩家数据持久化
  - 异步保存玩家数据（避免阻塞主线程）
  - 数据文件位置：`plugins/AbyssCurse/players/{UUID}.yml`
  - 玩家退出时自动保存
  - 定期自动保存（每5分钟）
- ✅ 实现了玩家数据加载
  - 玩家加入时从文件加载数据
  - 如果文件不存在，创建新数据（使用玩家当前 Y 坐标作为初始安全高度）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/data/PlayerDataManager.java`
- ✅ 相关类：`PlayerCurseData.java`（玩家诅咒数据类）

**技术实现**：
- 使用 YAML 格式存储玩家数据
- 异步保存：`BukkitScheduler.runTaskAsynchronously()`
- 数据文件结构：
  - `safeHeight`: 安全高度（double）
  - `lastY`: 上次检查时的 Y 坐标（double）
  - `currentLayer`: 当前诅咒层级（int，0表示无诅咒）
  - `curseStartTime`: 诅咒生效时间（long，时间戳）
  - `curseDuration`: 诅咒持续时间（long，tick数）
  - `curseArm`: 触发诅咒时的诅咒臂（int）
  - `isNarehate`: 是否为生骸（boolean）
  - `narehateType`: 生骸类型（String，LUCKY/SAD）

#### 3. 玩家诅咒数据类 (PlayerCurseData)
- ✅ 实现了累计上升高度计算
  - 使用时间戳队列（`Queue<Long>`）存储每次上升记录
  - 每个时间戳代表1格上升
  - 自动清理过期记录（20分钟后过期）
  - 性能优化：O(k) 清理过期项，k 为过期项数量
- ✅ 实现了安全高度管理
  - 玩家下降或累计上升高度清零时刷新安全高度
- ✅ 实现了诅咒相关数据存储
  - 当前诅咒层级（1-7，0表示无诅咒）
  - 诅咒生效时间和持续时间
  - 触发诅咒时的诅咒臂
- ✅ 实现了生骸相关数据存储
  - 是否为生骸
  - 生骸类型（LUCKY/SAD）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/data/PlayerCurseData.java`

**技术实现**：
- 使用 `ConcurrentLinkedQueue` 存储上升记录时间戳（线程安全）
- 累计上升过期时间：20分钟 = 20 * 60 * 1000 毫秒
- 累计上升记录不持久化（玩家退出时清零，重新进入游戏时从新的安全高度开始）

#### 4. 事件监听系统完善 (AbyssCurseListener)
- ✅ 实现了 `PlayerJoinEvent` 监听
  - 加载玩家数据（从文件或创建新数据）
  - 初始化安全高度（玩家进入游戏时的 Y 坐标）
  - 初始化 `lastY` 为当前 Y 坐标
  - 清空累计上升记录
  - 启动定时检查任务（每20tick检查一次Y坐标变化）
- ✅ 实现了 `PlayerQuitEvent` 监听
  - 停止定时检查任务
  - 保存玩家数据（异步）
- ✅ 实现了 `PlayerMoveEvent` 监听
  - 检测玩家进入/离开 Abyss 区域（用于提示）
  - 注意：实际的 Y 坐标检查在定时任务中进行，避免性能问题
- ✅ 实现了定时检查任务（每20tick执行一次）
  - 检查玩家 Y 坐标变化
  - 上升时：计算上升方块数并记录到累计上升高度
  - 下降时：刷新安全高度，不清除累计上升
  - 累计上升高度达到2m时：清空记录并刷新安全高度（触发诅咒逻辑在第三阶段实现）
  - 累计上升高度为零时：刷新安全高度
  - 检查玩家是否受诅咒影响（必须在 Abyss 内、不在豁免区、不是豁免者）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/AbyssCurseListener.java`

**技术实现**：
- 使用 `BukkitRunnable` 实现定时检查任务
- 每个玩家独立的定时任务（存储在 `Map<UUID, BukkitTask>` 中）
- 定时任务频率：每20tick（1秒）执行一次
- 事件优先级：`EventPriority.MONITOR`（只读，不修改事件）

#### 5. 主类集成
- ✅ 更新了 `AbyssCursePlugin` 主类
  - 集成了 `RegionManager`
  - 集成了 `PlayerDataManager`
  - 更新了 `DebugManager` 初始化（传入新模块）
  - 更新了事件监听器初始化（传入插件实例）
  - 实现了定期自动保存任务（每5分钟保存一次）
  - 插件卸载时保存所有玩家数据
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/AbyssCursePlugin.java`

#### 6. 调试管理器更新 (DebugManager)
- ✅ 更新了调试信息显示
  - 显示累计上升高度
  - 显示安全高度
  - 显示当前诅咒层级（如果有）
  - 显示是否在 Abyss 内
  - 显示是否在豁免区内
  - 显示是否为豁免者
  - 显示诅咒臂（如果在 Abyss 内）
- ✅ 更新了调试信息文本（`getDebugInfoText()`）
  - 显示所有玩家数据信息
  - 显示所有区域信息
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/debug/DebugManager.java`

### 技术实现

#### 文件结构
```
src/main/java/io/github/kaleidscoper/abysscurse/
├── AbyssCursePlugin.java (主类，已更新)
├── AbyssCurseListener.java (事件监听器，已完善)
├── config/
│   └── ConfigManager.java (配置管理器)
├── mode/
│   ├── PluginMode.java (模式枚举)
│   └── ModeManager.java (模式管理器)
├── region/ (新增)
│   ├── RegionManager.java (区域管理器)
│   └── ExemptionZone.java (豁免区数据类)
├── data/ (新增)
│   ├── PlayerDataManager.java (玩家数据管理器)
│   └── PlayerCurseData.java (玩家诅咒数据类)
├── command/
│   └── CommandHandler.java (命令处理器)
└── debug/
    └── DebugManager.java (调试管理器，已更新)
```

#### 核心特性
1. **区域判断优化**：使用切比雪夫距离计算，性能高效
2. **数据持久化**：异步保存，避免阻塞主线程
3. **累计上升计算**：使用时间戳队列，自动清理过期记录
4. **定时检查**：每20tick（1秒）检查一次，平衡性能和实时性
5. **线程安全**：使用 `ConcurrentHashMap` 和 `ConcurrentLinkedQueue` 保证线程安全

### 验证结果

#### 功能验证
- ✅ 区域判断功能正常（ABYSS、WORLD 模式）
- ✅ 诅咒臂计算正确
- ✅ 豁免区和豁免者判断正常
- ✅ 玩家数据加载和保存正常
- ✅ 累计上升高度计算正确（自动清理过期记录）
- ✅ 安全高度刷新逻辑正确
- ✅ 玩家进入/离开 Abyss 区域提示正常
- ✅ 定时检查任务正常工作
- ✅ 调试信息显示完整

#### 性能验证
- ✅ 区域判断：高效（切比雪夫距离计算）
- ✅ 累计上升计算：优化（O(k) 清理过期项）
- ✅ 数据持久化：异步处理，不阻塞主线程
- ✅ 定时检查：每20tick一次，性能开销合理

### 占位性功能说明

⚠️ **重要**：以下功能在当前阶段仅为占位实现，仅提供基础框架和接口，**没有实际功能**。这些功能需要在后续阶段完善。

#### 1. 诅咒触发逻辑
- **当前状态**：累计上升高度达到2m时会清空记录并刷新安全高度，但**不会实际触发诅咒效果**
- **占位内容**：
  - ✅ 累计上升高度计算和检查已完成
  - ❌ **没有 CurseManager**：无法判断诅咒层级
  - ❌ **没有 EffectManager**：无法施加诅咒效果
  - ❌ **没有 FilterManager**：无法显示红色滤镜
  - ❌ **没有 SoundManager**：无法播放诅咒音效
- **待实现**（第三阶段）：
  - 实现 CurseManager 和 AbyssCurseHandler
  - 实现诅咒层级判断（根据安全高度）
  - 实现诅咒触发逻辑
  - 实现动态诅咒持续时间计算（根据诅咒臂）

#### 2. 诅咒效果系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 EffectManager
  - ❌ 没有效果施加逻辑
  - ❌ 没有效果合并机制
  - ❌ 没有层级效果
- **待实现**（第三阶段）：
  - 实现 EffectManager
  - 实现诅咒效果施加器（CurseEffectApplier）
  - 实现层级效果施加器（LayerEffectApplier）
  - 实现效果合并逻辑（避免覆盖）
  - 实现效果定期刷新机制

#### 3. 滤镜系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 FilterManager
  - ❌ 没有红色滤镜显示
- **待实现**（第三阶段）：
  - 实现 FilterManager
  - 使用 ActionBar 显示红色滤镜（根据累计上升高度）
  - 第一层诅咒时显示重度滤镜

#### 4. 音效系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 SoundManager
  - ❌ 没有音效播放逻辑
- **待实现**（第三阶段）：
  - 实现 SoundManager
  - 诅咒触发时播放音效
  - 第三层随机播放音效

#### 5. 生骸系统
- **当前状态**：数据结构已准备，但转换逻辑未实现
- **占位内容**：
  - ✅ 玩家数据中已有生骸相关字段（`isNarehate`、`narehateType`）
  - ❌ **没有 NarehateManager**：无法转换生骸
  - ❌ 无法施加生骸效果
  - ❌ 第六层诅咒10分钟后未死亡不会自动转换
- **待实现**（第四阶段）：
  - 实现 NarehateManager
  - 实现生骸转换逻辑
  - 实现生骸效果管理

#### 6. 成就系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 AchievementManager
  - ❌ 无法触发成就
- **待实现**（第四阶段）：
  - 实现 AchievementManager
  - 创建成就树（使用 Paper Advancement API）
  - 实现成就触发逻辑

#### 7. 减压病模式
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 DecompressionSicknessHandler
  - ❌ 配置中有 `curse-mode` 配置项，但未实现实际逻辑
- **待实现**（第四阶段）：
  - 实现 DecompressionSicknessHandler
  - 实现减压病模式的诅咒逻辑

### 功能完整性说明

| 模块 | 框架 | 配置 | 实际功能 | 状态 |
|------|------|------|----------|------|
| ConfigManager | ✅ | ✅ | ✅ | 完整 |
| ModeManager | ✅ | ✅ | ⚠️ 占位 | 框架完成 |
| CommandHandler | ✅ | ✅ | ⚠️ 占位 | 框架完成 |
| DebugManager | ✅ | ✅ | ✅ | 完整 |
| AbyssCurseListener | ✅ | ❌ | ✅ | 完整 |
| RegionManager | ✅ | ✅ | ✅ | 完整 |
| PlayerDataManager | ✅ | ✅ | ✅ | 完整 |
| PlayerCurseData | ✅ | ❌ | ✅ | 完整 |
| CurseManager | ❌ | ❌ | ❌ | 未实现 |
| EffectManager | ❌ | ❌ | ❌ | 未实现 |
| FilterManager | ❌ | ❌ | ❌ | 未实现 |
| SoundManager | ❌ | ❌ | ❌ | 未实现 |
| NarehateManager | ❌ | ❌ | ❌ | 未实现 |
| AchievementManager | ❌ | ❌ | ❌ | 未实现 |

**图例**：
- ✅ = 已实现
- ⚠️ = 占位实现（无实际功能）
- ❌ = 未实现

### 已知问题
- 无

### 下一步计划
根据开发方案，下一阶段（阶段 III）将实现：
1. CurseManager - 诅咒管理器
2. EffectManager - 效果管理器
3. FilterManager - 滤镜管理器
4. SoundManager - 音效管理器
5. 诅咒触发逻辑和效果施加

### 接手开发指南

#### 快速开始
1. **阅读文档**：
   - `doc/需求文档.md` - 了解完整需求
   - `doc/开发方案.md` - 了解技术实现方案
   - `doc/ROADMAP.md` - 了解开发路线图

2. **理解当前状态**：
   - 当前已完成基础框架（阶段 I）和区域系统（阶段 II）
   - 区域判断、玩家数据管理、累计上升高度计算已实现
   - 诅咒触发逻辑已准备，但实际效果施加在第三阶段实现

3. **测试当前功能**：
   ```bash
   # 构建插件
   ./gradlew build
   
   # 在服务器上测试
   /abysscurse mode abyss 0 64 0 5  # 切换到区域模式并设置区域
   /abysscurse debug on              # 开启调试模式
   # 玩家在 Abyss 区域内上升超过2m，会看到累计上升高度增加
   # 但不会触发实际诅咒效果（第三阶段实现）
   ```

4. **下一步开发建议**：
   - 优先实现 CurseManager（诅咒触发逻辑是核心）
   - 然后实现 EffectManager（效果施加）
   - 最后实现 FilterManager 和 SoundManager（视觉和听觉效果）

#### 代码结构说明
- **已完成模块**：可以直接使用，API 稳定
- **占位功能**：需要实现实际逻辑，但接口已预留
- **未实现模块**：需要从零开始实现

#### 注意事项
- ⚠️ **不要删除占位代码**：占位代码提供了接口和结构，是后续开发的基础
- ⚠️ **保持模块化**：新增功能应遵循现有的模块化设计
- ⚠️ **异步处理**：所有文件 I/O 和耗时操作必须使用异步任务
- ⚠️ **性能优化**：参考开发方案中的性能优化建议
- ⚠️ **累计上升记录不持久化**：玩家退出时清零，重新进入游戏时从新的安全高度开始

### 备注
- 所有代码遵循 Java 编码规范
- 使用 PaperMC 1.21.10 API
- 配置文件使用 YAML 格式
- 日志使用 Bukkit Logger 系统
- 占位功能标记：在代码中使用 `// TODO: 占位实现` 或 `// FIXME: 需要实现实际功能` 注释

### DebugManager 实现说明

**实现时间**：2024年（补充第一阶段缺失功能）

**实现原因**：
根据 `doc/第一阶段检验报告.md`，DebugManager 是 ROADMAP 中明确要求的第一阶段任务，但在初始实现中被遗漏了。

**未实现的原因分析**：
1. 第一阶段很多依赖功能尚未实现（PlayerDataManager、RegionManager 等）
2. 可能认为调试系统不是第一阶段的核心功能
3. 配置文件中已有 `debug.enabled` 配置项，但未实现实际功能

**实现内容**：
- ✅ 调试信息显示：使用 ActionBar 实时显示调试信息，每秒更新一次
- ✅ 调试模式控制：支持全局和玩家级别调试开关
- ✅ 调试命令：实现了完整的调试命令处理
- ✅ 集成完整：已集成到主类和命令系统
- ✅ 预留接口：为后续功能扩展预留了完整接口

**使用说明**：
- 玩家调试模式：`/abysscurse debug <on|off|toggle|info>`
- 全局调试模式：`/abysscurse debug global <on|off>`
- 配置文件：在 `config.yml` 中设置 `debug.enabled: true` 后重载配置

**后续扩展**：
当 PlayerDataManager、RegionManager、CurseManager 等模块实现后，可以在 `buildDebugInfo()` 方法中添加更多调试信息显示（当前层级、累计上升高度、安全高度、是否在 abyss 内等）。

**验证结果**：
- ✅ 编译测试：通过 Gradle 编译，无错误
- ✅ 代码质量：符合项目编码规范
- ✅ 功能完整性：实现了 ROADMAP 中要求的基础功能
- ✅ 扩展性：为后续功能预留了接口

---

## 阶段 III：核心诅咒与效果系统（已完成）

### 完成时间
2024年（第三阶段）

### 完成内容

#### 1. 诅咒管理器 (CurseManager)
- ✅ 实现了诅咒触发逻辑
  - 当玩家累计上升高度达到2m时触发诅咒
  - 根据触发诅咒时的安全高度判断诅咒层级（1-7层）
  - 计算动态诅咒持续时间（根据诅咒臂和 Abyss 半径）
- ✅ 实现了诅咒持续时间检查
  - 定期检查诅咒是否过期（每20tick检查一次）
  - 诅咒过期时清除效果和数据
  - 第六层和第七层特殊处理（生骸转换和强制击杀）
- ✅ 集成了滤镜管理器和音效管理器
  - 第一层诅咒时显示重度滤镜
  - 第三层诅咒时播放随机音效
  - 所有诅咒触发时播放诅咒音效
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/curse/CurseManager.java`
- ✅ 相关接口：`CurseEffectHandler.java`（诅咒效果处理器接口）

**技术实现**：
- 使用 BukkitRunnable 实现定时检查任务
- 诅咒持续时间计算公式：`10分钟 * (abyss半径 - 诅咒臂) / abyss半径`
- 诅咒层级判断基于安全高度，而非当前高度

#### 2. 效果管理器 (EffectManager)
- ✅ 实现了诅咒效果施加
  - 根据诅咒层级施加对应效果（1-7层）
  - 效果叠加逻辑（层级越高效果越多）
  - 支持动态持续时间管理
- ✅ 实现了效果合并逻辑
  - 使用优先级系统避免效果覆盖
  - 优先级：生骸效果 > 层级效果 > 诅咒效果 > 临时效果
  - 相同优先级时，强度高的覆盖强度低的
  - 短时效果优先保护（避免永久效果覆盖短时效果）
- ✅ 实现了效果定期刷新机制
  - 每20tick（1秒）刷新一次所有玩家效果
  - 自动清理过期效果
  - 确保永久效果持续生效
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/effect/EffectManager.java`

**技术实现**：
- 使用 `Map<UUID, Map<PotionEffectType, EffectData>>` 存储玩家效果
- 效果数据包含类型、强度、持续时间、来源和时间戳
- 不使用 `force=true`，而是先移除再添加，避免覆盖问题

**各层诅咒效果列表**：
1. **第一层**：反胃
2. **第二层**：反胃 + 饥饿3 + 缓慢6
3. **第三层**：以上所有 + 黑暗1
4. **第四层**：以上所有 + 霉运 + 挖掘疲劳3 + 虚弱
5. **第五层**：以上所有 + 失明 + 中毒2
6. **第六层**：以上所有 + 凋零2
7. **第七层**：以上所有 + 瞬间伤害2

#### 3. 层级效果管理器 (LayerEffectManager)
- ✅ 实现了永久层级效果管理
  - 根据玩家当前高度判断层级（1-7层）
  - 施加对应层级的永久效果
  - 层级变化时自动移除旧效果并施加新效果
- ✅ 集成了视觉管理器
  - 层级变化时显示 Title 和 Subtitle
  - 更新 BossBar 显示当前层级
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/effect/LayerEffectManager.java`

**技术实现**：
- 每20tick（1秒）检查一次玩家高度
- 使用 EffectManager 的 `removeEffectsBySource()` 方法移除层级效果

**各层层级效果列表**：
1. **第一层**：生命恢复
2. **第二层**：伤害吸收1
3. **第三层**：抗性提升
4. **第四层**：夜视 + 急迫 + 迅捷 + 力量
5. **第五层**：无效果
6. **第六层**：幸运
7. **第七层**：缓降

#### 4. 滤镜管理器 (FilterManager)
- ✅ 实现了红色滤镜显示
  - 使用 ActionBar 显示全屏宽度的红色渐变文本
  - 根据累计上升高度显示不同强度的滤镜（0/1/2）
  - 第一层诅咒时强制显示重度滤镜
- ✅ 实现了滤镜定期更新
  - 每5tick（0.25秒）更新一次
  - 确保滤镜效果持续显示
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/filter/FilterManager.java`

**技术实现**：
- 使用 Paper 1.21 的 Adventure API（Component、TextColor）
- 使用全角方块字符（`█`）填满 ActionBar
- 颜色强度：累计上升1使用 RGB(255, 100, 100)，累计上升2使用 RGB(200, 0, 0)

#### 5. 音效管理器 (SoundManager)
- ✅ 实现了诅咒触发音效
  - 使用远古守卫者施加挖掘疲劳时的音效（`ENTITY_ELDER_GUARDIAN_CURSE`）
- ✅ 实现了第三层随机音效播放
  - 构建音效库（怪物音效、洞穴氛围音效、TNT 点燃音效）
  - 每3-5秒随机播放一次音效
  - 诅咒结束时自动停止
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/sound/SoundManager.java`

**技术实现**：
- 使用 `List<Sound>` 存储音效库
- 使用 BukkitRunnable 实现随机音效任务
- 随机间隔：60-100tick（3-5秒）

#### 6. 视觉管理器 (VisualManager)
- ✅ 实现了 Title/Subtitle 层级提示
  - 玩家进入新层级时显示 Title 和 Subtitle
  - 不同层级使用不同颜色（红色、绿色、灰色、天青色、蓝色、金色、白色）
  - 淡入淡出效果（500ms 淡入，3秒显示，500ms 淡出）
- ✅ 实现了 BossBar 层级显示
  - 显示当前层级名称
  - 根据层级设置不同颜色
  - 进度条根据层级设置（1-7层对应0.14-1.0）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/visual/VisualManager.java`

**技术实现**：
- 使用 Paper 1.21 的 Adventure API（Title、Component）
- 使用 Bukkit BossBar API
- 检测层级变化，只在变化时显示 Title

#### 7. 事件监听器更新 (AbyssCurseListener)
- ✅ 集成了诅咒触发逻辑
  - 累计上升高度达到2m时调用 `CurseManager.triggerCurse()`
  - 传递安全高度参数用于判断诅咒层级
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/AbyssCurseListener.java`

#### 8. 主类集成 (AbyssCursePlugin)
- ✅ 集成了所有新模块
  - CurseManager、EffectManager、LayerEffectManager
  - FilterManager、SoundManager、VisualManager
- ✅ 实现了模块间依赖注入
  - CurseManager 注入 EffectHandler、FilterManager、SoundManager
  - LayerEffectManager 注入 VisualManager
- ✅ 实现了优雅的关闭流程
  - 停止所有管理器的定时任务
  - 清理所有资源
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/AbyssCursePlugin.java`

### 技术实现

#### 文件结构
```
src/main/java/io/github/kaleidscoper/abysscurse/
├── AbyssCursePlugin.java (主类，已更新)
├── AbyssCurseListener.java (事件监听器，已更新)
├── curse/ (新增)
│   ├── CurseManager.java (诅咒管理器)
│   └── CurseEffectHandler.java (诅咒效果处理器接口)
├── effect/ (新增)
│   ├── EffectManager.java (效果管理器)
│   └── LayerEffectManager.java (层级效果管理器)
├── filter/ (新增)
│   └── FilterManager.java (滤镜管理器)
├── sound/ (新增)
│   └── SoundManager.java (音效管理器)
└── visual/ (新增)
    └── VisualManager.java (视觉管理器)
```

#### 核心特性
1. **模块化设计**：各功能模块独立，通过接口交互
2. **效果合并系统**：智能合并多个来源的效果，避免覆盖
3. **动态持续时间**：根据诅咒臂动态计算诅咒持续时间
4. **视觉反馈**：Title、BossBar、滤镜、音效全方位反馈
5. **性能优化**：合理的更新频率，避免性能问题

### 验证结果

#### 功能验证
- ✅ 诅咒触发逻辑正确（累计上升2m触发）
- ✅ 诅咒层级判断正确（根据安全高度）
- ✅ 诅咒持续时间计算正确（根据诅咒臂）
- ✅ 诅咒效果施加正确（各层效果叠加）
- ✅ 层级效果施加正确（根据当前高度）
- ✅ 滤镜显示正确（根据累计上升高度）
- ✅ 音效播放正确（诅咒触发和第三层随机音效）
- ✅ 视觉显示正确（Title、BossBar）

#### 性能验证
- ✅ 效果刷新：每20tick一次，性能开销合理
- ✅ 滤镜更新：每5tick一次，视觉效果流畅
- ✅ 诅咒检查：每20tick一次，性能开销合理

### 占位性功能说明

⚠️ **重要**：以下功能在当前阶段仅为占位实现，仅提供基础框架和接口，**没有实际功能**。这些功能需要在后续阶段完善。

#### 1. 生骸系统
- **当前状态**：数据结构已准备，但转换逻辑未实现
- **占位内容**：
  - ✅ 玩家数据中已有生骸相关字段（`isNarehate`、`narehateType`）
  - ✅ CurseManager 中已有第六层诅咒过期时的占位代码
  - ❌ **没有 NarehateManager**：无法转换生骸
  - ❌ 无法施加生骸效果
  - ❌ 第六层诅咒10分钟后未死亡不会自动转换
- **待实现**（第四阶段）：
  - 实现 NarehateManager
  - 实现生骸转换逻辑（第六层诅咒10分钟后未死亡）
  - 实现生骸效果管理（幸运生骸/悲惨生骸）
  - 实现生骸豁免机制（在 CurseManager 中检查）

#### 2. 成就系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 AchievementManager
  - ❌ 无法触发成就
  - ❌ 没有成就 JSON 文件
- **待实现**（第四阶段）：
  - 实现 AchievementManager
  - 创建成就树（使用 Paper Advancement API）
  - 实现成就触发逻辑（进入层级时触发）
  - 创建成就 JSON 文件（`advancements/`）

#### 3. 减压病模式
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 DecompressionSicknessHandler
  - ❌ 配置中有 `curse-mode` 配置项，但未实现实际逻辑
  - ❌ 无法切换到减压病模式
- **待实现**（第四阶段）：
  - 实现 DecompressionSicknessHandler
  - 实现减压病模式的诅咒逻辑（根据当前高度，永久持续）
  - 集成到 CurseManager 或创建独立的处理器

#### 4. 第五层特殊限制
- **当前状态**：部分实现
- **占位内容**：
  - ✅ 效果已实现（失明、中毒等）
  - ❌ **禁止使用右键**：未实现（需要监听 PlayerInteractEvent）
  - ❌ **游戏静音**：未实现（需要客户端设置，可能需要特殊处理）
  - ❌ **聊天栏不可见**：未实现（需要监听聊天事件，隐藏聊天消息）
- **待实现**（第三阶段补充或第四阶段）：
  - 在 AbyssCurseListener 中添加 PlayerInteractEvent 监听（第五层禁用右键）
  - 实现聊天栏隐藏逻辑（监听 AsyncPlayerChatEvent，取消或隐藏消息）
  - 研究游戏静音的实现方案（可能需要客户端插件或特殊 API）

#### 5. 第六、七层聊天栏限制
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ **不再允许打开聊天栏**：未实现（但可以看见内容）
  - ❌ 需要监听聊天事件，禁止输入和发送
- **待实现**（第三阶段补充或第四阶段）：
  - 在 AbyssCurseListener 中添加聊天事件监听
  - 检查玩家是否在第六、七层，如果是则取消聊天事件

#### 6. 第六层寄生效果
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ **寄生（虫蚀）**：未实现（具体用法有待参考官方文档）
  - ❌ 需要研究 Paper 1.21 中是否有相关 API
- **待实现**（第四阶段）：
  - 研究 Paper 1.21 的寄生/虫蚀效果 API
  - 实现寄生效果施加逻辑

#### 7. 第七层强制击杀
- **当前状态**：已实现基础逻辑
- **占位内容**：
  - ✅ CurseManager 中已有强制击杀代码（`player.setHealth(0)`）
  - ⚠️ **可能需要优化**：确保在诅咒过期时立即执行，避免延迟
- **待优化**（可选）：
  - 确保强制击杀逻辑可靠执行
  - 添加日志记录

### 功能完整性说明

| 模块 | 框架 | 配置 | 实际功能 | 状态 |
|------|------|------|----------|------|
| ConfigManager | ✅ | ✅ | ✅ | 完整 |
| ModeManager | ✅ | ✅ | ✅ | 完整 |
| CommandHandler | ✅ | ✅ | ✅ | 完整 |
| DebugManager | ✅ | ✅ | ✅ | 完整 |
| AbyssCurseListener | ✅ | ❌ | ✅ | 完整 |
| RegionManager | ✅ | ✅ | ✅ | 完整 |
| PlayerDataManager | ✅ | ✅ | ✅ | 完整 |
| PlayerCurseData | ✅ | ❌ | ✅ | 完整 |
| CurseManager | ✅ | ❌ | ✅ | 完整 |
| EffectManager | ✅ | ❌ | ✅ | 完整 |
| LayerEffectManager | ✅ | ❌ | ✅ | 完整 |
| FilterManager | ✅ | ❌ | ✅ | 完整 |
| SoundManager | ✅ | ❌ | ✅ | 完整 |
| VisualManager | ✅ | ❌ | ✅ | 完整 |
| NarehateManager | ❌ | ❌ | ❌ | 未实现 |
| AchievementManager | ❌ | ❌ | ❌ | 未实现 |
| DecompressionSicknessHandler | ❌ | ❌ | ❌ | 未实现 |

**图例**：
- ✅ = 已实现
- ⚠️ = 占位实现（无实际功能）
- ❌ = 未实现

### 已知问题
- 第五层特殊限制（禁止右键、游戏静音、聊天栏不可见）未完全实现
- 第六、七层聊天栏限制未实现
- 第六层寄生效果未实现（需要研究 API）
- ConfigManager 的导入错误可能是 IDE 缓存问题，实际编译应该正常

### 下一步计划
根据开发方案，下一阶段（阶段 IV）将实现：
1. NarehateManager - 生骸系统
2. AchievementManager - 成就系统
3. DecompressionSicknessHandler - 减压病模式
4. 补充第五、六、七层的特殊限制功能
5. 性能优化和全面测试

### 接手开发指南

#### 快速开始
1. **阅读文档**：
   - `doc/需求文档.md` - 了解完整需求
   - `doc/开发方案.md` - 了解技术实现方案
   - `doc/ROADMAP.md` - 了解开发路线图

2. **理解当前状态**：
   - 当前已完成基础框架（阶段 I）、区域系统（阶段 II）和核心诅咒系统（阶段 III）
   - 诅咒功能已基本可用，玩家上升2m会触发诅咒效果
   - 部分特殊功能（第五层限制、第六层寄生等）尚未实现

3. **测试当前功能**：
   ```bash
   # 构建插件
   ./gradlew build
   
   # 在服务器上测试
   /abysscurse mode abyss 0 64 0 5  # 切换到区域模式并设置区域
   /abysscurse debug on              # 开启调试模式
   # 玩家在 Abyss 区域内上升超过2m，会触发诅咒效果
   # 可以看到滤镜、音效、Title、BossBar 等效果
   ```

4. **下一步开发建议**：
   - 优先实现 NarehateManager（生骸系统是核心玩法之一）
   - 然后实现 AchievementManager（成就系统增强体验）
   - 最后实现 DecompressionSicknessHandler（扩展功能）
   - 补充第五、六、七层的特殊限制功能

#### 代码结构说明
- **已完成模块**：可以直接使用，API 稳定
- **占位功能**：需要实现实际逻辑，但接口已预留
- **未实现模块**：需要从零开始实现

#### 注意事项
- ⚠️ **不要删除占位代码**：占位代码提供了接口和结构，是后续开发的基础
- ⚠️ **保持模块化**：新增功能应遵循现有的模块化设计
- ⚠️ **异步处理**：所有文件 I/O 和耗时操作必须使用异步任务
- ⚠️ **性能优化**：参考开发方案中的性能优化建议
- ⚠️ **效果合并**：使用 EffectManager 统一管理所有效果，避免覆盖问题

### 备注
- 所有代码遵循 Java 编码规范
- 使用 PaperMC 1.21.10 API
- 配置文件使用 YAML 格式
- 日志使用 Bukkit Logger 系统
- 占位功能标记：在代码中使用 `// TODO: 占位实现` 或 `// FIXME: 需要实现实际功能` 注释

