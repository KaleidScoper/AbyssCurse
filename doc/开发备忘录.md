# AbyssCurse 插件开发备忘录

## 阶段 I：插件基础框架（已完成）

### 完成时间
2024年（第一阶段）

### 完成内容

#### 1. 配置管理系统 (ConfigManager)
- ✅ 实现了配置文件的加载和保存
- ✅ 支持默认配置值设置
- ✅ 提供配置重载功能
- ✅ 管理插件模式、Abyss区域配置、诅咒模式、调试开关等配置项
- ✅ 配置文件位置：`plugins/AbyssCurse/config.yml`

#### 2. 模式管理系统 (ModeManager)
- ✅ 实现了三种插件模式的管理：
  - `OFF`: 关闭模式，插件不对任何玩家施加诅咒
  - `ABYSS`: 区域开启模式，仅在定义的 abyss 区域内施加诅咒
  - `WORLD`: 全部开启模式，整个主世界都被视为 abyss
- ✅ 模式切换验证（ABYSS 模式需要有效的区域配置）
- ✅ 模式状态查询接口

#### 3. 命令处理系统 (CommandHandler)
- ✅ 实现了基础命令处理框架
- ✅ 支持的命令：
  - `/abysscurse mode <off|abyss|world> [x] [y] [z] [radius]` - 切换插件模式
  - `/abysscurse reload` - 重载配置文件
  - `/abysscurse info` - 查看插件信息
  - `/abysscurse debug <on|off|toggle|info|global> [on|off]` - 调试模式控制
  - `/abysscurse` - 显示帮助信息
- ✅ 实现了命令补全（TabCompleter）
- ✅ 权限检查（`abysscurse.admin`）
- ✅ 友好的错误提示和帮助信息

#### 4. 调试管理系统 (DebugManager)
- ✅ 实现了调试信息显示功能（ActionBar 实时显示）
- ✅ 支持全局调试开关（通过配置文件或命令）
- ✅ 支持玩家级别调试开关（每个玩家独立控制）
- ✅ 实现了调试命令处理
- ✅ 每秒更新一次调试信息（每 20 tick）
- ✅ 显示当前可获取的信息：
  - 当前模式（OFF/ABYSS/WORLD）
  - 玩家位置坐标
  - Abyss 区域信息（中心坐标和半径，仅在 ABYSS 模式下显示）
- ✅ 为后续功能预留接口（当前层级、累计上升高度、安全高度等）
- ✅ 文件位置：`src/main/java/io/github/kaleidscoper/abysscurse/debug/DebugManager.java`

**调试命令**：
- `/abysscurse debug on` - 开启玩家调试模式
- `/abysscurse debug off` - 关闭玩家调试模式
- `/abysscurse debug toggle` - 切换玩家调试模式
- `/abysscurse debug info` - 查看详细调试信息（聊天栏）
- `/abysscurse debug global <on|off>` - 控制全局调试模式

**技术实现**：
- 使用 Paper 1.21 的 Adventure API（Component、NamedTextColor）
- 使用 BukkitScheduler 实现定时更新
- 使用 HashSet<UUID> 存储调试玩家列表，保证线程安全

**预留接口**（待后续阶段完善）：
- 当前层级 - 需要 PlayerDataManager
- 累计上升高度 - 需要 PlayerDataManager
- 安全高度 - 需要 PlayerDataManager
- 是否在 abyss 内 - 需要 RegionManager
- 是否在豁免区内 - 需要 RegionManager
- 是否为生骸 - 需要 PlayerDataManager

#### 5. 主类集成
- ✅ 更新了 `AbyssCursePlugin` 主类
- ✅ 集成了所有管理器模块
- ✅ 实现了优雅的启动和关闭流程
- ✅ 异常处理和日志记录

#### 6. 配置文件
- ✅ 创建了 `plugin.yml`，包含命令和权限定义
- ✅ 创建了默认 `config.yml` 配置文件
- ✅ 命令别名：`ac`, `abyss`

### 技术实现

#### 文件结构
```
src/main/java/io/github/kaleidscoper/abysscurse/
├── AbyssCursePlugin.java (主类)
├── AbyssCurseListener.java (事件监听器)
├── config/
│   └── ConfigManager.java (配置管理器)
├── mode/
│   ├── PluginMode.java (模式枚举)
│   └── ModeManager.java (模式管理器)
├── command/
│   └── CommandHandler.java (命令处理器)
└── debug/
    └── DebugManager.java (调试管理器)
```

#### 核心特性
1. **模块化设计**：各功能模块独立，通过接口交互
2. **配置驱动**：支持配置文件和命令动态配置
3. **性能优化**：使用单例模式管理资源，避免重复创建
4. **错误处理**：完善的异常处理和用户友好的错误提示
5. **可扩展性**：为后续功能扩展预留接口

### 验证结果

#### 功能验证
- ✅ 插件能正常加载和卸载
- ✅ 配置文件能正确创建和加载
- ✅ 模式切换命令正常工作
- ✅ 命令补全功能正常
- ✅ 权限检查正常工作
- ✅ 构建成功，无编译错误

#### 性能验证
- ✅ 启动时间：快速（< 1秒）
- ✅ 内存占用：低（基础框架）
- ✅ 命令响应：即时

### 占位性功能说明

⚠️ **重要**：以下功能在当前阶段仅为占位实现，仅提供基础框架和接口，**没有实际功能**。这些功能需要在后续阶段完善。

#### 1. 事件监听器 (AbyssCurseListener)
- **当前状态**：仅实现了 `PlayerJoinEvent` 监听，显示欢迎消息
- **占位内容**：
  - 仅发送欢迎消息，无其他功能
  - 未实现玩家数据加载
  - 未实现安全高度初始化
  - 未实现其他事件监听（PlayerMoveEvent、PlayerQuitEvent 等）
- **待实现**：
  - 玩家加入时加载数据并初始化安全高度
  - 玩家移动事件监听（检测 Y 坐标变化）
  - 玩家退出时保存数据
  - 其他相关事件监听

#### 2. 模式切换功能
- **当前状态**：可以切换模式并保存到配置文件
- **占位内容**：
  - ✅ 模式状态可以切换和保存
  - ❌ **没有实际功能**：切换模式后不会对游戏产生任何影响
  - ❌ 不会检查玩家是否在 Abyss 区域内
  - ❌ 不会根据模式施加或移除诅咒效果
- **待实现**：
  - 模式切换时通知相关模块（RegionManager、CurseManager）
  - 根据模式状态实际控制诅咒系统
  - 模式切换时的效果清理和重新应用

#### 3. Abyss 区域配置
- **当前状态**：可以设置和保存 Abyss 区域配置（中心坐标和半径）
- **占位内容**：
  - ✅ 配置可以保存到文件
  - ❌ **没有 RegionManager**：无法判断玩家是否在 Abyss 区域内
  - ❌ 无法计算诅咒臂（Arm of Curse）
  - ❌ 无法判断玩家是否在豁免区内
- **待实现**：
  - 实现 RegionManager 模块
  - 实现区域判断逻辑（切比雪夫距离计算）
  - 实现豁免区管理
  - 实现区域查询 API

#### 4. 诅咒系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 CurseManager
  - ❌ 没有累计上升高度计算
  - ❌ 没有诅咒触发逻辑
  - ❌ 没有诅咒效果施加
- **待实现**：
  - 实现 CurseManager 和 AbyssCurseHandler
  - 实现累计上升高度计算（时间窗口队列）
  - 实现诅咒触发条件判断
  - 实现诅咒层级判断（根据安全高度）
  - 实现动态诅咒持续时间计算

#### 5. 效果系统
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 EffectManager
  - ❌ 没有效果施加逻辑
  - ❌ 没有效果合并机制
  - ❌ 没有层级效果
- **待实现**：
  - 实现 EffectManager
  - 实现诅咒效果施加器（CurseEffectApplier）
  - 实现层级效果施加器（LayerEffectApplier）
  - 实现效果合并逻辑（避免覆盖）
  - 实现效果定期刷新机制

#### 6. 玩家数据管理
- **当前状态**：完全未实现
- **占位内容**：
  - ❌ 没有 PlayerDataManager
  - ❌ 没有玩家数据持久化
  - ❌ 没有玩家数据加载
  - ❌ 没有安全高度、累计上升高度等数据存储
- **待实现**：
  - 实现 PlayerDataManager
  - 实现 PlayerCurseData 数据结构
  - 实现数据持久化（异步保存）
  - 实现数据加载和初始化

#### 7. 其他占位功能
- **滤镜系统**：未实现（FilterManager）
- **音效系统**：未实现（SoundManager）
- **生骸系统**：未实现（NarehateManager）
- **成就系统**：未实现（AchievementManager）

### 功能完整性说明

| 模块 | 框架 | 配置 | 实际功能 | 状态 |
|------|------|------|----------|------|
| ConfigManager | ✅ | ✅ | ✅ | 完整 |
| ModeManager | ✅ | ✅ | ⚠️ 占位 | 框架完成 |
| CommandHandler | ✅ | ✅ | ⚠️ 占位 | 框架完成 |
| DebugManager | ✅ | ✅ | ✅ | 完整 |
| AbyssCurseListener | ✅ | ❌ | ⚠️ 占位 | 仅欢迎消息 |
| RegionManager | ❌ | ❌ | ❌ | 未实现 |
| PlayerDataManager | ❌ | ❌ | ❌ | 未实现 |
| CurseManager | ❌ | ❌ | ❌ | 未实现 |
| EffectManager | ❌ | ❌ | ❌ | 未实现 |

**图例**：
- ✅ = 已实现
- ⚠️ = 占位实现（无实际功能）
- ❌ = 未实现

### 已知问题
- 无

### 下一步计划
根据开发方案，下一阶段将实现：
1. RegionManager - 区域管理系统
2. PlayerDataManager - 玩家数据管理系统
3. 事件监听系统完善（PlayerMoveEvent 等）

### 接手开发指南

#### 快速开始
1. **阅读文档**：
   - `doc/需求文档.md` - 了解完整需求
   - `doc/开发方案.md` - 了解技术实现方案
   - `doc/ROADMAP.md` - 了解开发路线图

2. **理解当前状态**：
   - 当前仅完成基础框架（阶段 I）
   - 所有核心功能都是占位实现，无实际效果
   - 模式切换命令可以执行，但不会产生游戏内影响

3. **测试当前功能**：
   ```bash
   # 构建插件
   ./gradlew build
   
   # 在服务器上测试
   /abysscurse mode off      # 切换到关闭模式
   /abysscurse mode abyss 0 64 0 5  # 切换到区域模式并设置区域
   /abysscurse mode world    # 切换到世界模式
   /abysscurse info          # 查看插件信息
   /abysscurse reload        # 重载配置
   /abysscurse debug on      # 开启调试模式（显示 ActionBar 信息）
   /abysscurse debug info    # 查看详细调试信息
   /abysscurse debug global on  # 开启全局调试模式
   ```

4. **下一步开发建议**：
   - 优先实现 RegionManager（区域判断是核心功能的基础）
   - 然后实现 PlayerDataManager（数据管理是诅咒系统的基础）
   - 最后实现 CurseManager 和 EffectManager（核心玩法）

#### 代码结构说明
- **已完成模块**：可以直接使用，API 稳定
- **占位功能**：需要实现实际逻辑，但接口已预留
- **未实现模块**：需要从零开始实现

#### 注意事项
- ⚠️ **不要删除占位代码**：占位代码提供了接口和结构，是后续开发的基础
- ⚠️ **保持模块化**：新增功能应遵循现有的模块化设计
- ⚠️ **异步处理**：所有文件 I/O 和耗时操作必须使用异步任务
- ⚠️ **性能优化**：参考开发方案中的性能优化建议

### 备注
- 所有代码遵循 Java 编码规范
- 使用 PaperMC 1.21.10 API
- 配置文件使用 YAML 格式
- 日志使用 Bukkit Logger 系统
- 占位功能标记：在代码中使用 `// TODO: 占位实现` 或 `// FIXME: 需要实现实际功能` 注释

### DebugManager 实现说明

**实现时间**：2024年（补充第一阶段缺失功能）

**实现原因**：
根据 `doc/第一阶段检验报告.md`，DebugManager 是 ROADMAP 中明确要求的第一阶段任务，但在初始实现中被遗漏了。

**未实现的原因分析**：
1. 第一阶段很多依赖功能尚未实现（PlayerDataManager、RegionManager 等）
2. 可能认为调试系统不是第一阶段的核心功能
3. 配置文件中已有 `debug.enabled` 配置项，但未实现实际功能

**实现内容**：
- ✅ 调试信息显示：使用 ActionBar 实时显示调试信息，每秒更新一次
- ✅ 调试模式控制：支持全局和玩家级别调试开关
- ✅ 调试命令：实现了完整的调试命令处理
- ✅ 集成完整：已集成到主类和命令系统
- ✅ 预留接口：为后续功能扩展预留了完整接口

**使用说明**：
- 玩家调试模式：`/abysscurse debug <on|off|toggle|info>`
- 全局调试模式：`/abysscurse debug global <on|off>`
- 配置文件：在 `config.yml` 中设置 `debug.enabled: true` 后重载配置

**后续扩展**：
当 PlayerDataManager、RegionManager、CurseManager 等模块实现后，可以在 `buildDebugInfo()` 方法中添加更多调试信息显示（当前层级、累计上升高度、安全高度、是否在 abyss 内等）。

**验证结果**：
- ✅ 编译测试：通过 Gradle 编译，无错误
- ✅ 代码质量：符合项目编码规范
- ✅ 功能完整性：实现了 ROADMAP 中要求的基础功能
- ✅ 扩展性：为后续功能预留了接口

