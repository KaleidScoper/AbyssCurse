# 一、插件模式

插件存在三个模式：关闭（off模式）、区域开启（abyss模式）、全部开启（world模式）。具有管理员权限的玩家应该能用命令改变这个模式。

## 1 off模式

这是默认插件模式。

在关闭模式下插件不对任何玩家或生物施加后文提到的“诅咒”。

## 2 abyss模式

允许使用者通过某种方式（可以写死在配置文件内，也可以让管理员玩家在切换至此模式时填写），在主世界定义一个被称为abyss的区域的位置和大小。

abyss的位置指的是其中心区块。让使用者给出区块号很困难，所以仅需要让使用者给出中心区块内的任意一个方块坐标即可，由插件判断这是哪一个区块。因为abyss区域本质上是一个区块集合，这就导致它包含其范围内的全部高度，即世界高度下限-64到世界高度上限320。

abyss的大小指的是一个值，该值是一个切比雪夫距离，单位是区块，与中心区块距离在这个切比雪夫距离之内的所有区块都将被纳入abyss。

<!--

 在这里说一下为什么使用切比雪夫。原作里阿比斯深渊当然是圆形，按理说应该使用欧几里得距离，但是此插件需要各种频繁的监听，欧式将产生性能问题。此外在mc中的深渊是方形很符合直觉。

 此外我很好奇在此处使用区块和使用方块来定义的性能开销有什么区别。

-->

## 3 world模式

整个主世界都被视为是abyss。

# 二、诅咒

## 1 目标

诅咒只以abyss区域内的玩家为“目标”。

## 2 豁免

允许管理员玩家用两个角点（必须给出完整xyz坐标）来定义豁免区，豁免区内的目标不受诅咒影响，即使豁免区位于abyss内部。

允许管理员玩家将某个玩家定义为豁免者（称为生骸，narehate）。豁免者在任何情况下都不受诅咒影响。豁免者具有的其他性质将在后文提供。

## 3 诅咒模式

有两个诅咒模式，abyss-curse模式和decompression-sickness模式。其表现略有不同，将在后文说明。

### abyss-curse 模式

这是默认诅咒模式。

诅咒只对作用范围内，二十分钟内累计上升距离超过2m（y差值超过2）的目标起作用。

玩家进入游戏时的y坐标被存储为安全高度记录。每次下降、或“累计上升高度清零”时将刷新安全高度（将当前高度设为新的安全高度）

“累计上升”指的是，插件每秒（20tick）检查一次每个目标的当前y坐标，如果是上升，每格上升都会被实时记录（累计上升高度+1），并在20分钟后自动过期（-1），为零时将当时的目标y坐标设为新的安全高度。如果是下降，不积累也不消除“累计上升高度”，但也刷新安全高度。若玩家累计上升高度达到2，将被施加一次“诅咒内容”，然后清零累计上升高度、刷新安全高度以待重新记录。

每一格“累计上升高度”会让玩家的画面笼罩红色滤镜。0时正常，1到2逐渐加重。

### decompression-sickness 模式

诅咒只对区域内某个高度范围的目标起作用。

## 4 诅咒内容

### abyss-curse 模式

该模式下受到的诅咒，和触发时记录的安全高度有关。当此安全高度位于不同区间时，受到持续十分钟的下列诅咒：

- 一、阿比斯之渊 Edge of the Abyss
  - 高度范围：96 > y >= 85
  - 诅咒：反胃 + 视野笼罩累计上升高度2的滤镜
- 二、诱惑之森 Forest of Temptation
  - 高度范围：85 > y >= 75
  - 诅咒：以上所有 + 饥饿3 + 缓慢6
- 三、大断层 Great Fault
  - 高度范围：75 > y >= 40
  - 诅咒：以上所有 + 黑暗1 + 随机播放音效（音效库包括所有怪物音效、所有洞穴氛围音效、TNT点燃音效）
- 四、巨人之杯 Goblets of Giants
  - 高度范围：40 > y >= 0
  - 诅咒：以上所有 + 霉运 + 挖掘疲劳3 + 虚弱
- 五、亡骸之海 Sea of Corpses
  - 高度范围：0 > y >= -8
  - 诅咒：以上所有 + 失明 禁止使用右键 游戏静音 中毒2 聊天栏不可见 
- 六、来无还之都 Capital of the Unreturned
  - 高度范围：-8 > y >= -28
  - 诅咒：以上全部 + 寄生 + 凋零2，十分钟后诅咒结束未死则化身豁免者（生骸）
- 七、最终极之涡 Final Maelstrom
  - 高度范围：-28 > y >= -64
  - 诅咒：以上全部 + 瞬间伤害2

任何层级的诅咒触发时，都向目标玩家播放“远古守卫者施加挖掘疲劳时”的音效。

除了诅咒之外，每一层还带有“效果”，施加给高度位于其范围的玩家，只要没脱离范围就永久生效，具体如下：

- 一、进入时显示红色Title 阿比斯之渊，subtitle Edge of the Abyss，此后以此类推
  - 高度范围：96 > y >= 85
  - 效果：生命恢复，获得成就“‌赤笛”
- 二、绿色 诱惑之森 Forest of Temptation
  - 高度范围：85 > y >= 75
  - 效果：伤害吸收1，获得成就“‌苍笛”
- 三、灰色 大断层 Great Fault
  - 高度范围：75 > y >= 40
  - 效果：抗性提升，获得成就“‌月笛”
- 四、天青色 巨人之杯 Goblets of Giants
  - 高度范围：40 > y >= 0
  - 效果：夜视 + 急迫 + 迅捷 + 力量，获得成就“‌黑笛”
- 五、蓝色 亡骸之海 Sea of Corpses
  - 高度范围：0 > y >= -8
  - 效果：无，获得成就“‌白笛”。此成就是“一个挑战类进度”。音效事件为ui.toast.challenge_complete。
- 六、金色 来无还之都 Capital of the Unreturned
  - 高度范围：-8 > y >= -28
  - 效果：幸运，不再允许打开聊天栏（但是可以看见内容），获得成就“‌绝界行”。此成就是“一个挑战类进度”。音效事件为ui.toast.challenge_complete。
- 七、白色 最终极之涡 Final Maelstrom
  - 高度范围：-28 > y >= -64
  - 效果：缓降，不再允许打开聊天栏（但是可以看见内容），获得成就“‌奈落之底”。此成就是“一个挑战类进度”。音效事件为ui.toast.challenge_complete。

### decompression-sickness 模式

该模式下的诅咒只和玩家所处的高度有关，并且永久持续。

- 一、浅层
  - 高度范围：y >= 0
  - 诅咒：abyss-curse 模式中第六层的诅咒内容
- 二、深层
  - 高度范围：0 > y >= -64
  - 诅咒：无

# 三、生骸

## 1 祝福

生骸（豁免者）具有一系列被称为祝福的永久性效果。

- 生骸不再受任何诅咒影响。
- 成为生骸就立刻达成成就“来自深渊”。
  - 此成就是“一个挑战类进度”。音效事件为ui.toast.challenge_complete。
- 变成生骸时，玩家从下列身份中随机获得一个：
  - 幸运生骸，永久获得以下正面效果：迅捷2，急迫2，力量2，跳跃提升2，夜视，生命恢复2，村庄英雄，海豚的恩惠，潮涌能量，幸运
  - 悲惨生骸，永久获得以下正面效果：生命恢复2，抗性提升4，伤害吸收4，抗火，水下呼吸，缓降，聊天栏永久不可打开（即不可输入和发送），但是可以看见聊天栏信息

# 四、其他

## 成就

本插件添加的成就树称为“深渊”，和原版分离开、互相独立，且隐藏。

成就树如下：
- 阿比斯之渊（达成条件：根节点，默认达成；描述文本：故事从这里开始）
  - 赤笛（描述文本：望向深渊）
    - 苍笛（描述文本：离开摇篮）
      - 月笛（描述文本：刻写历史）
        - 黑笛（描述文本：带回故事）
          - 白笛（描述文本：成为传说）
            - 绝界行（描述文本：有去无回）
              - 来自深渊（描述文本：回归深渊）
              - 奈落之底（描述文本：故事不会从这里结束）

## API文档

Paper MC官方文档位于：https://jd.papermc.io/paper/1.21.10/

## 开发须知

1. 所有持久化与日志写入应放在异步任务中
2. 多个状态可能同时对玩家应用不同效果，以后将集中统一计算最终合并，避免覆盖。
3. 如果需要用到美术资源、但暂时缺失，请给出占位文件（比如美术资源.png.txt）
4. 允许管理员打开（比如键入命令开启）开发用模式，在聊天栏输出当前层、累计上升高度、安全高度，便于调试。
